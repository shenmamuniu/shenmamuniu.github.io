{"title":"C# 使用Topshelf安装windows服务","slug":"129","date":"2022-06-22T06:04:26.000Z","updated":"2022-06-22T06:04:26.000Z","comments":true,"path":"api/articles/129.json","excerpt":"最近在使用c# 控制台程序接收tcp数据时，经常运行一段时间后服务中断,需要和之前运行jar包一样，按下ctrl+c程序才会恢复,因此想到.net中将控制台程序转到后台运行,将其安装为windows服务。","covers":null,"content":"<p>最近在使用c# 控制台程序接收tcp数据时，经常运行一段时间后服务中断,需要和之前运行jar包一样，按下ctrl+c程序才会恢复,因此想到.net中将控制台程序转到后台运行,将其安装为windows服务。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"应用环境\"><a href=\"#应用环境\" class=\"headerlink\" title=\"应用环境\"></a>应用环境</h2><p>OS:win10<br>IDE:vs2019<br>.NET版本:4.5.2<br>Topshelf:4.0.3</p>\n<h2 id=\"Topshelf的安装\"><a href=\"#Topshelf的安装\" class=\"headerlink\" title=\"Topshelf的安装\"></a>Topshelf的安装</h2><p>通过visual studio的nuget包管理器安装topshelf包,支持的最低版本为.net framework4.5.2。</p>\n<h2 id=\"Topshelf的使用\"><a href=\"#Topshelf的使用\" class=\"headerlink\" title=\"Topshelf的使用\"></a>Topshelf的使用</h2><p>创建一个控制台程序,添加如下内容:</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">HostFactory.Run(x &#x3D;&gt; &#123;\n    x.Service&lt;TaskService&gt;();\n    x.RunAsLocalSystem();\n    x.SetDescription(description);\n    x.SetDisplayName(displayName);\n    x.SetServiceName(serviceName);\n&#125;);            \nConsole.ReadKey();<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>添加TaskService类:</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">public class AISService : ServiceControl\n&#123;\n    public bool Start(HostControl hostControl)\n    &#123;\n        \n    &#125;\n\n    public bool Stop(HostControl hostControl)\n    &#123;\n    \n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>添加完之后，生成项目。</p>\n<h2 id=\"服务安装和卸载\"><a href=\"#服务安装和卸载\" class=\"headerlink\" title=\"服务安装和卸载\"></a>服务安装和卸载</h2><p>在cmd窗口中，输入以下命令安装:</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">.&#x2F;xxx.exe install<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>卸载：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">.&#x2F;xxx.exe uninstall<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"c-程序以管理员身份运行程序\"><a href=\"#c-程序以管理员身份运行程序\" class=\"headerlink\" title=\"c# 程序以管理员身份运行程序\"></a>c# 程序以管理员身份运行程序</h2><p>添加应用程序清单文件，即app.manifest,将requestedExecutionLevel部分改为以下内容:</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&lt;requestedExecutionLevel  level&#x3D;&quot;requireAdministrator&quot; uiAccess&#x3D;&quot;false&quot; &#x2F;&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"Referenced\"><a href=\"#Referenced\" class=\"headerlink\" title=\"Referenced\"></a>Referenced</h2><p><a href=\"https://alisonmarket.lofter.com/post/2b1789_1c7361bf1#\">1、封面图</a></p>\n","more":"<h2 id=\"应用环境\"><a href=\"#应用环境\" class=\"headerlink\" title=\"应用环境\"></a>应用环境</h2><p>OS:win10<br>IDE:vs2019<br>.NET版本:4.5.2<br>Topshelf:4.0.3</p>\n<h2 id=\"Topshelf的安装\"><a href=\"#Topshelf的安装\" class=\"headerlink\" title=\"Topshelf的安装\"></a>Topshelf的安装</h2><p>通过visual studio的nuget包管理器安装topshelf包,支持的最低版本为.net framework4.5.2。</p>\n<h2 id=\"Topshelf的使用\"><a href=\"#Topshelf的使用\" class=\"headerlink\" title=\"Topshelf的使用\"></a>Topshelf的使用</h2><p>创建一个控制台程序,添加如下内容:</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">HostFactory.Run(x &#x3D;&gt; &#123;\n    x.Service&lt;TaskService&gt;();\n    x.RunAsLocalSystem();\n    x.SetDescription(description);\n    x.SetDisplayName(displayName);\n    x.SetServiceName(serviceName);\n&#125;);            \nConsole.ReadKey();<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>添加TaskService类:</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">public class AISService : ServiceControl\n&#123;\n    public bool Start(HostControl hostControl)\n    &#123;\n        \n    &#125;\n\n    public bool Stop(HostControl hostControl)\n    &#123;\n    \n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>添加完之后，生成项目。</p>\n<h2 id=\"服务安装和卸载\"><a href=\"#服务安装和卸载\" class=\"headerlink\" title=\"服务安装和卸载\"></a>服务安装和卸载</h2><p>在cmd窗口中，输入以下命令安装:</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">.&#x2F;xxx.exe install<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>卸载：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">.&#x2F;xxx.exe uninstall<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"c-程序以管理员身份运行程序\"><a href=\"#c-程序以管理员身份运行程序\" class=\"headerlink\" title=\"c# 程序以管理员身份运行程序\"></a>c# 程序以管理员身份运行程序</h2><p>添加应用程序清单文件，即app.manifest,将requestedExecutionLevel部分改为以下内容:</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">&lt;requestedExecutionLevel  level&#x3D;&quot;requireAdministrator&quot; uiAccess&#x3D;&quot;false&quot; &#x2F;&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"Referenced\"><a href=\"#Referenced\" class=\"headerlink\" title=\"Referenced\"></a>Referenced</h2><p><a href=\"https://alisonmarket.lofter.com/post/2b1789_1c7361bf1#\">1、封面图</a></p>","categories":[{"name":"语言","path":"api/categories/语言.json"}],"tags":[{"name":"C","path":"api/tags/C.json"}]}