{"title":"Mysql主从复制","slug":"8","date":"2019-11-14T14:49:00.000Z","updated":"2020-04-04T03:17:46.000Z","comments":true,"path":"api/articles/8.json","excerpt":"Mysql主从复制又叫Mysql主从同步，是构建数据库高可用集群架构的基础，它通过将一台主机的数据复制到其他一台或多台主机上，并重新应用日志(Relay log)中的SQL语句来实现复制功能。","covers":null,"content":"<p>Mysql主从复制又叫Mysql主从同步，是构建数据库高可用集群架构的基础，它通过将一台主机的数据复制到其他一台或多台主机上，并重新应用日志(Relay log)中的SQL语句来实现复制功能。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"运行环境\"><a href=\"#运行环境\" class=\"headerlink\" title=\"运行环境\"></a>运行环境</h2><p>Ubuntu 16.04(3个虚拟机，其中一主两从)</p>\n<p>Mysql版本：5.7.23</p>\n<h2 id=\"Master配置\"><a href=\"#Master配置\" class=\"headerlink\" title=\"Master配置\"></a>Master配置</h2><h3 id=\"开启二进制日志\"><a href=\"#开启二进制日志\" class=\"headerlink\" title=\"开启二进制日志\"></a>开启二进制日志</h3><p>   vi &#x2F;etc&#x2F;mysql&#x2F;mysql.conf.d&#x2F;mysqld.cnf</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">添加以下部分\n[mysqld]\nlog_bin&#x3D;mysql-bin   &#x2F;&#x2F;[必须]启用二进制日志\nserver-id&#x3D;140       &#x2F;&#x2F;[必须]服务器唯一ID，默认是1，一般取IP最后一段<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<pre><code>Mysql默认同步所有的数据库，也可以指定同步或不同步哪些数据库，添加配置：\n</code></pre>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\"># 不同步哪些数据库\nbinlog-ignore-db &#x3D; mysql\nbinlog-ignore-db &#x3D; test\nbinlog-ignore-db &#x3D; information_schema\n\n# 只同步哪些数据库，除此之外，其他不同步\nbinlog-do-db &#x3D; game<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><strong>注意：</strong>这里无论是binlog—do-db还是binlog_ingore_db，如果需要设置多个数据库的时候，不要用逗号隔开，另起一行重新写即可，参考上面的binlog-ignore-db的写0法。</p>\n<p>重启Mysql数据库</p>\n<h3 id=\"创建用于同步的账户并授权\"><a href=\"#创建用于同步的账户并授权\" class=\"headerlink\" title=\"创建用于同步的账户并授权\"></a>创建用于同步的账户并授权</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">mysql -u root -p \n\nmysql&gt;CREATE USER &#39;username@%&#39; [IDENTIFIED BY &#39;PASSWORD&#39;] \\g\n\nmysql&gt; grant all privileges on *.* to yyzc@&quot;%&quot; identified by &quot;.&quot; \\g\nQuery OK, 0 rows affected (0.00 sec)\n\nmysql&gt; flush privileges; \\g\nQuery OK, 0 rows affected (0.00 sec)\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"查看状态\"><a href=\"#查看状态\" class=\"headerlink\" title=\"查看状态\"></a>查看状态</h3><p>获取File及Position的信息</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">mysql&gt;show master status \\g\n+------------------+----------+--------------+------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |\n+------------------+----------+--------------+------------------+\n| mysql-bin.000004 |      308 |              |                  |\n+------------------+----------+--------------+------------------+<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"Slave配置\"><a href=\"#Slave配置\" class=\"headerlink\" title=\"Slave配置\"></a>Slave配置</h2><h3 id=\"开启二进制日志并重启Mysql\"><a href=\"#开启二进制日志并重启Mysql\" class=\"headerlink\" title=\"开启二进制日志并重启Mysql\"></a>开启二进制日志并重启Mysql</h3><h3 id=\"配置从服务器Slave及启动复制\"><a href=\"#配置从服务器Slave及启动复制\" class=\"headerlink\" title=\"配置从服务器Slave及启动复制\"></a>配置从服务器Slave及启动复制</h3><p>   其中master_log_file及master_log_pos从Master中获取</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">mysql&gt;change master to master_host&#x3D;&#39;192.168.245.140&#39;,master_user&#x3D;&#39;mysync&#39;,master_password&#x3D;&#39;123456&#39;,master_log_file&#x3D;&#39;mysql-bin.000004&#39;,master_log_pos&#x3D;308;  \nmysql&gt;start slave;    &#x2F;&#x2F;启动从服务器复制功能<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<h3 id=\"查看Slave的状态\"><a href=\"#查看Slave的状态\" class=\"headerlink\" title=\"查看Slave的状态\"></a>查看Slave的状态</h3><p>   其中：Slave_IO及Slave_SQL进程必须正常运行，即YES状态，否则都是错误的状态。</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">mysql&gt; show slave status \\g<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"同步遇到的问题\"><a href=\"#同步遇到的问题\" class=\"headerlink\" title=\"同步遇到的问题\"></a>同步遇到的问题</h2><ol>\n<li><p>因为是虚拟机复制的，所以Mysql的uuid是相同的导致复制失败</p>\n<p>修改:&#x2F;var&#x2F;lib&#x2F;mysql中的auto.cnf中的server-uuid即可</p>\n</li>\n</ol>\n<h2 id=\"Referenced\"><a href=\"#Referenced\" class=\"headerlink\" title=\"Referenced\"></a>Referenced</h2><p>1.Mysql Replication浅析 ：<a href=\"https://www.cnblogs.com/zhenyuyaodidiao/p/4635458.html\">https://www.cnblogs.com/zhenyuyaodidiao/p/4635458.html</a></p>\n<p>2.Mysql创建用户：<a href=\"https://www.cnblogs.com/z-books/p/6681777.html\">https://www.cnblogs.com/z-books/p/6681777.html</a></p>\n<p>3.Mysql主从复制(Master-Slave)实践：<a href=\"https://www.cnblogs.com/gl-developer/p/6170423.html\">https://www.cnblogs.com/gl-developer/p/6170423.html</a></p>\n<p>4.Mysql uuid相同导致主从复制失败：<a href=\"https://segmentfault.com/q/1010000010173393\">https://segmentfault.com/q/1010000010173393</a></p>\n<p>5.<a href=\"https://blog.csdn.net/mengtianyalll/article/details/52683021\">mysql binlog_do_db参数设置的坑</a><br><a href=\"http://mubai745.lofter.com/post/1effea90_1c6f4464a\">6. 封面来源</a></p>\n","more":"<h2 id=\"运行环境\"><a href=\"#运行环境\" class=\"headerlink\" title=\"运行环境\"></a>运行环境</h2><p>Ubuntu 16.04(3个虚拟机，其中一主两从)</p>\n<p>Mysql版本：5.7.23</p>\n<h2 id=\"Master配置\"><a href=\"#Master配置\" class=\"headerlink\" title=\"Master配置\"></a>Master配置</h2><h3 id=\"开启二进制日志\"><a href=\"#开启二进制日志\" class=\"headerlink\" title=\"开启二进制日志\"></a>开启二进制日志</h3><p>   vi &#x2F;etc&#x2F;mysql&#x2F;mysql.conf.d&#x2F;mysqld.cnf</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">添加以下部分\n[mysqld]\nlog_bin&#x3D;mysql-bin   &#x2F;&#x2F;[必须]启用二进制日志\nserver-id&#x3D;140       &#x2F;&#x2F;[必须]服务器唯一ID，默认是1，一般取IP最后一段<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n<pre><code>Mysql默认同步所有的数据库，也可以指定同步或不同步哪些数据库，添加配置：\n</code></pre>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\"># 不同步哪些数据库\nbinlog-ignore-db &#x3D; mysql\nbinlog-ignore-db &#x3D; test\nbinlog-ignore-db &#x3D; information_schema\n\n# 只同步哪些数据库，除此之外，其他不同步\nbinlog-do-db &#x3D; game<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p><strong>注意：</strong>这里无论是binlog—do-db还是binlog_ingore_db，如果需要设置多个数据库的时候，不要用逗号隔开，另起一行重新写即可，参考上面的binlog-ignore-db的写0法。</p>\n<p>重启Mysql数据库</p>\n<h3 id=\"创建用于同步的账户并授权\"><a href=\"#创建用于同步的账户并授权\" class=\"headerlink\" title=\"创建用于同步的账户并授权\"></a>创建用于同步的账户并授权</h3><pre class=\"line-numbers language-none\"><code class=\"language-none\">mysql -u root -p \n\nmysql&gt;CREATE USER &#39;username@%&#39; [IDENTIFIED BY &#39;PASSWORD&#39;] \\g\n\nmysql&gt; grant all privileges on *.* to yyzc@&quot;%&quot; identified by &quot;.&quot; \\g\nQuery OK, 0 rows affected (0.00 sec)\n\nmysql&gt; flush privileges; \\g\nQuery OK, 0 rows affected (0.00 sec)\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"查看状态\"><a href=\"#查看状态\" class=\"headerlink\" title=\"查看状态\"></a>查看状态</h3><p>获取File及Position的信息</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">mysql&gt;show master status \\g\n+------------------+----------+--------------+------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |\n+------------------+----------+--------------+------------------+\n| mysql-bin.000004 |      308 |              |                  |\n+------------------+----------+--------------+------------------+<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"Slave配置\"><a href=\"#Slave配置\" class=\"headerlink\" title=\"Slave配置\"></a>Slave配置</h2><h3 id=\"开启二进制日志并重启Mysql\"><a href=\"#开启二进制日志并重启Mysql\" class=\"headerlink\" title=\"开启二进制日志并重启Mysql\"></a>开启二进制日志并重启Mysql</h3><h3 id=\"配置从服务器Slave及启动复制\"><a href=\"#配置从服务器Slave及启动复制\" class=\"headerlink\" title=\"配置从服务器Slave及启动复制\"></a>配置从服务器Slave及启动复制</h3><p>   其中master_log_file及master_log_pos从Master中获取</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">mysql&gt;change master to master_host&#x3D;&#39;192.168.245.140&#39;,master_user&#x3D;&#39;mysync&#39;,master_password&#x3D;&#39;123456&#39;,master_log_file&#x3D;&#39;mysql-bin.000004&#39;,master_log_pos&#x3D;308;  \nmysql&gt;start slave;    &#x2F;&#x2F;启动从服务器复制功能<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<h3 id=\"查看Slave的状态\"><a href=\"#查看Slave的状态\" class=\"headerlink\" title=\"查看Slave的状态\"></a>查看Slave的状态</h3><p>   其中：Slave_IO及Slave_SQL进程必须正常运行，即YES状态，否则都是错误的状态。</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">mysql&gt; show slave status \\g<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"同步遇到的问题\"><a href=\"#同步遇到的问题\" class=\"headerlink\" title=\"同步遇到的问题\"></a>同步遇到的问题</h2><ol>\n<li><p>因为是虚拟机复制的，所以Mysql的uuid是相同的导致复制失败</p>\n<p>修改:&#x2F;var&#x2F;lib&#x2F;mysql中的auto.cnf中的server-uuid即可</p>\n</li>\n</ol>\n<h2 id=\"Referenced\"><a href=\"#Referenced\" class=\"headerlink\" title=\"Referenced\"></a>Referenced</h2><p>1.Mysql Replication浅析 ：<a href=\"https://www.cnblogs.com/zhenyuyaodidiao/p/4635458.html\">https://www.cnblogs.com/zhenyuyaodidiao/p/4635458.html</a></p>\n<p>2.Mysql创建用户：<a href=\"https://www.cnblogs.com/z-books/p/6681777.html\">https://www.cnblogs.com/z-books/p/6681777.html</a></p>\n<p>3.Mysql主从复制(Master-Slave)实践：<a href=\"https://www.cnblogs.com/gl-developer/p/6170423.html\">https://www.cnblogs.com/gl-developer/p/6170423.html</a></p>\n<p>4.Mysql uuid相同导致主从复制失败：<a href=\"https://segmentfault.com/q/1010000010173393\">https://segmentfault.com/q/1010000010173393</a></p>\n<p>5.<a href=\"https://blog.csdn.net/mengtianyalll/article/details/52683021\">mysql binlog_do_db参数设置的坑</a><br><a href=\"http://mubai745.lofter.com/post/1effea90_1c6f4464a\">6. 封面来源</a></p>","categories":[],"tags":[{"name":"Mysql","path":"api/tags/Mysql.json"},{"name":"数据库集群","path":"api/tags/数据库集群.json"}]}