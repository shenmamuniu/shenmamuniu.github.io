{"title":"Nginx控制TerraGate地形服务的访问权限","slug":"69","date":"2020-08-18T07:25:49.000Z","updated":"2020-08-18T07:25:49.000Z","comments":true,"path":"api/articles/69.json","realPath":null,"excerpt":"本文主要解决TerraGate地形服务的权限控制问题，这里通过Nginx对访问者的ip及useragent分别不同的地形服务的访问权限进行控制。","covers":null,"cover":null,"content":"<p>本文主要解决TerraGate地形服务的权限控制问题，这里通过Nginx对访问者的ip及useragent分别不同的地形服务的访问权限进行控制。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h2><p>TerraGate:5.6.1<br>OS:Win Server 2008 R2<br>Nginx:1.9</p>\n<h2 id=\"UserAgent\"><a href=\"#UserAgent\" class=\"headerlink\" title=\"UserAgent\"></a>UserAgent</h2><p>调用terragate的地形服务的系统，一般只有TerraExplorer，因此UserAgent这里只有”TerraExplorer”,如果是其他的UA,直接返回403即可</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">if ($http_user_agent !~ &quot;TerraExplorer&quot;)&#123;\n                return 403;\n            &#125;    <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"使用Nginx中的if\"><a href=\"#使用Nginx中的if\" class=\"headerlink\" title=\"使用Nginx中的if\"></a>使用Nginx中的if</h2><p>这里主要对用户访问的地形文件的名字和用户ip进行判断,限制特定ip只能访问某个或某些地形文件服务。<br>Nginx是不支持if…else的，要实现多条件判断，只能通过添加变量来实现</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">set $flag 0;\nif ($remote_addr ~ &#39;(192)\\.(168)\\.(10)\\.(.*)&#39;)&#123;\n                set $flag &quot;$&#123;flag&#125;1&quot;;\n            &#125;\n            if ($request_uri ~ &#39;&#x2F;\\d+\\?1226xuanran\\.mpt&#39;)&#123;\n                set $flag &quot;$&#123;flag&#125;1&quot;;\n            &#125; \n       \n            if ($flag &#x3D; &quot;011&quot;)&#123;\n                proxy_pass http:&#x2F;&#x2F;xxx:8081;\n            &#125;\n         <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>注意，这里由于访问mpt服务之前，会访问一个类似全图的图片，但此地址中又不包含1226xuanran，因此添加了如下部分</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">if ($request_uri !~ &#39;&#x2F;\\d+.*mpt.*&#39;)&#123;\n               set $flag &quot;$&#123;flag&#125;2&quot;;\n           &#125;      \n  if ($flag &#x3D; &quot;012&quot;)&#123;\n                proxy_pass http:&#x2F;&#x2F;xxx:8081;\n           &#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>即当请求uri中不包含mpt时，直接放行，代理到真实的地形服务中去。</p>\n<h2 id=\"其它Nginx正则表达式相关\"><a href=\"#其它Nginx正则表达式相关\" class=\"headerlink\" title=\"其它Nginx正则表达式相关\"></a>其它Nginx正则表达式相关</h2><p>&#x3D;\t开头表示精确匹配<br>~\t开头表示区分大小写的正则匹配<br><del>*\t开头表示不区分大小写的正则匹配<br>!</del>和!~*\t分别为区分大小写不匹配及不区分大小写不匹配 的正则<br>&#x2F;\t通用匹配，任何请求都会匹配到。</p>\n<h2 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h2><p><a href=\"https://www.blyoo.com/3865.html\">1. Nginx 判断访问者IP</a><br><a href=\"https://www.cnblogs.com/lazy-sang/p/12394649.html\">2. nginx if多条件判断</a><br><a href=\"https://www.kancloud.cn/allanyu/openresty-best-practices/82607\">3. OpenResty最佳实践</a><br><a href=\"https://huadou145.lofter.com/post/205d4db3_1c84a2eba\">4.封面图源</a></p>\n","more":"<h2 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h2><p>TerraGate:5.6.1<br>OS:Win Server 2008 R2<br>Nginx:1.9</p>\n<h2 id=\"UserAgent\"><a href=\"#UserAgent\" class=\"headerlink\" title=\"UserAgent\"></a>UserAgent</h2><p>调用terragate的地形服务的系统，一般只有TerraExplorer，因此UserAgent这里只有”TerraExplorer”,如果是其他的UA,直接返回403即可</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">if ($http_user_agent !~ &quot;TerraExplorer&quot;)&#123;\n                return 403;\n            &#125;    <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"使用Nginx中的if\"><a href=\"#使用Nginx中的if\" class=\"headerlink\" title=\"使用Nginx中的if\"></a>使用Nginx中的if</h2><p>这里主要对用户访问的地形文件的名字和用户ip进行判断,限制特定ip只能访问某个或某些地形文件服务。<br>Nginx是不支持if…else的，要实现多条件判断，只能通过添加变量来实现</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">set $flag 0;\nif ($remote_addr ~ &#39;(192)\\.(168)\\.(10)\\.(.*)&#39;)&#123;\n                set $flag &quot;$&#123;flag&#125;1&quot;;\n            &#125;\n            if ($request_uri ~ &#39;&#x2F;\\d+\\?1226xuanran\\.mpt&#39;)&#123;\n                set $flag &quot;$&#123;flag&#125;1&quot;;\n            &#125; \n       \n            if ($flag &#x3D; &quot;011&quot;)&#123;\n                proxy_pass http:&#x2F;&#x2F;xxx:8081;\n            &#125;\n         <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>注意，这里由于访问mpt服务之前，会访问一个类似全图的图片，但此地址中又不包含1226xuanran，因此添加了如下部分</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">if ($request_uri !~ &#39;&#x2F;\\d+.*mpt.*&#39;)&#123;\n               set $flag &quot;$&#123;flag&#125;2&quot;;\n           &#125;      \n  if ($flag &#x3D; &quot;012&quot;)&#123;\n                proxy_pass http:&#x2F;&#x2F;xxx:8081;\n           &#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>即当请求uri中不包含mpt时，直接放行，代理到真实的地形服务中去。</p>\n<h2 id=\"其它Nginx正则表达式相关\"><a href=\"#其它Nginx正则表达式相关\" class=\"headerlink\" title=\"其它Nginx正则表达式相关\"></a>其它Nginx正则表达式相关</h2><p>&#x3D;\t开头表示精确匹配<br>~\t开头表示区分大小写的正则匹配<br><del>*\t开头表示不区分大小写的正则匹配<br>!</del>和!~*\t分别为区分大小写不匹配及不区分大小写不匹配 的正则<br>&#x2F;\t通用匹配，任何请求都会匹配到。</p>\n<h2 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h2><p><a href=\"https://www.blyoo.com/3865.html\">1. Nginx 判断访问者IP</a><br><a href=\"https://www.cnblogs.com/lazy-sang/p/12394649.html\">2. nginx if多条件判断</a><br><a href=\"https://www.kancloud.cn/allanyu/openresty-best-practices/82607\">3. OpenResty最佳实践</a><br><a href=\"https://huadou145.lofter.com/post/205d4db3_1c84a2eba\">4.封面图源</a></p>","categories":[{"name":"GIS","path":"api/categories/GIS.json"}],"tags":[{"name":"Nginx","path":"api/tags/Nginx.json"},{"name":"GIS","path":"api/tags/GIS.json"},{"name":"TerraGate","path":"api/tags/TerraGate.json"}]}