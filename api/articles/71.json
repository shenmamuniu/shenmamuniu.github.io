{"title":"Nginx添加Stream模块代理tcp服务","slug":"71","date":"2020-09-08T07:50:00.000Z","updated":"2020-09-08T08:08:58.000Z","comments":true,"path":"api/articles/71.json","realPath":null,"excerpt":"在百度云上部署了一个tcp服务，但是服务ip只能使用云服务器的内网ip,这样外网就没法访问到了，因此这里使用Nginx的stream模块代理tcp服务。","covers":null,"cover":null,"content":"<p>在百度云上部署了一个tcp服务，但是服务ip只能使用云服务器的内网ip,这样外网就没法访问到了，因此这里使用Nginx的stream模块代理tcp服务。</p>\n<span id=\"more\"></span>\n<h2 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h2><p>Nginx：1.19.1<br>OS:ubuntu 18.04</p>\n<h2 id=\"Nginx查看版本及配置\"><a href=\"#Nginx查看版本及配置\" class=\"headerlink\" title=\"Nginx查看版本及配置\"></a>Nginx查看版本及配置</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">nginx -V<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<h2 id=\"编译Nginx源码\"><a href=\"#编译Nginx源码\" class=\"headerlink\" title=\"编译Nginx源码\"></a>编译Nginx源码</h2><p>根据已安装nginx版本下载源码，这里给nginx添加stream模块</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">.&#x2F;configure --with-http_ssl_module --with-stream \nmake<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p>编译完成之后，将objs目录中的nginx复制到&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin下，覆盖即可<br>此时再执行nginx -V,会看到配置参数有了with-stream</p>\n<h2 id=\"Nginx代理TCP端口-1\"><a href=\"#Nginx代理TCP端口-1\" class=\"headerlink\" title=\"Nginx代理TCP端口[1]\"></a>Nginx代理TCP端口[1]</h2><p>配置如下,其中stream和http同级</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">stream \n&#123;\n    upstream cloudsocket \n    &#123;\n        hash $remote_addr consistent;\n        server 10.x.xx.14:1831 weight&#x3D;5 max_fails&#x3D;3 fail_timeout&#x3D;30s;\n    &#125;\n    server \n    &#123;\n        listen 8081;\n        proxy_connect_timeout 1s;\n        proxy_timeout 3s;\n        proxy_pass cloudsocket;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"nginx替换或版本升级\"><a href=\"#nginx替换或版本升级\" class=\"headerlink\" title=\"nginx替换或版本升级\"></a>nginx替换或版本升级</h2><p>把apt install nginx安装的nginx替换为源码编译的：</p>\n<ol>\n<li>通过apt install nginx安装的nginx在&#x2F;usr&#x2F;sbin下，把此目录下的nginx重新命名</li>\n<li>修改环境变量，添加源码编译的nginx的路径<pre class=\"line-numbers language-none\"><code class=\"language-none\">export PATH&#x3D;$PATH:&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n再通过nginx -V查看nginx的版本即可验证。</li>\n</ol>\n<h2 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h2><p><a href=\"https://www.cnblogs.com/kamil/p/6066715.html\">1、Nginx代理Tcp端口</a><br><a href=\"https://shiyuhei10456.lofter.com/post/3126465a_1c76bf4d6\">2、封面图源</a></p>\n","more":"<h2 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h2><p>Nginx：1.19.1<br>OS:ubuntu 18.04</p>\n<h2 id=\"Nginx查看版本及配置\"><a href=\"#Nginx查看版本及配置\" class=\"headerlink\" title=\"Nginx查看版本及配置\"></a>Nginx查看版本及配置</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">nginx -V<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<h2 id=\"编译Nginx源码\"><a href=\"#编译Nginx源码\" class=\"headerlink\" title=\"编译Nginx源码\"></a>编译Nginx源码</h2><p>根据已安装nginx版本下载源码，这里给nginx添加stream模块</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">.&#x2F;configure --with-http_ssl_module --with-stream \nmake<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n<p>编译完成之后，将objs目录中的nginx复制到&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin下，覆盖即可<br>此时再执行nginx -V,会看到配置参数有了with-stream</p>\n<h2 id=\"Nginx代理TCP端口-1\"><a href=\"#Nginx代理TCP端口-1\" class=\"headerlink\" title=\"Nginx代理TCP端口[1]\"></a>Nginx代理TCP端口[1]</h2><p>配置如下,其中stream和http同级</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">stream \n&#123;\n    upstream cloudsocket \n    &#123;\n        hash $remote_addr consistent;\n        server 10.x.xx.14:1831 weight&#x3D;5 max_fails&#x3D;3 fail_timeout&#x3D;30s;\n    &#125;\n    server \n    &#123;\n        listen 8081;\n        proxy_connect_timeout 1s;\n        proxy_timeout 3s;\n        proxy_pass cloudsocket;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"nginx替换或版本升级\"><a href=\"#nginx替换或版本升级\" class=\"headerlink\" title=\"nginx替换或版本升级\"></a>nginx替换或版本升级</h2><p>把apt install nginx安装的nginx替换为源码编译的：</p>\n<ol>\n<li>通过apt install nginx安装的nginx在&#x2F;usr&#x2F;sbin下，把此目录下的nginx重新命名</li>\n<li>修改环境变量，添加源码编译的nginx的路径<pre class=\"line-numbers language-none\"><code class=\"language-none\">export PATH&#x3D;$PATH:&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n再通过nginx -V查看nginx的版本即可验证。</li>\n</ol>\n<h2 id=\"Reference\"><a href=\"#Reference\" class=\"headerlink\" title=\"Reference\"></a>Reference</h2><p><a href=\"https://www.cnblogs.com/kamil/p/6066715.html\">1、Nginx代理Tcp端口</a><br><a href=\"https://shiyuhei10456.lofter.com/post/3126465a_1c76bf4d6\">2、封面图源</a></p>","categories":[{"name":"Linux","path":"api/categories/Linux.json"}],"tags":[{"name":"Nginx","path":"api/tags/Nginx.json"},{"name":"TCP","path":"api/tags/TCP.json"}]}