{"title":"Nginx结合geoip2实现按地区过滤用户","slug":"23","date":"2019-11-27T14:10:00.000Z","updated":"2019-11-27T14:12:49.000Z","comments":true,"path":"api/articles/23.json","realPath":null,"excerpt":"本文主要讲述Nginx结合GeoIP2实现对不同地区用户提供不同的服务。通过为在编译Nginx时加入ngx_http_geoip2模块，结合免费的geolite2数据库，实现用户来源的筛选。","covers":null,"cover":null,"content":"<p>本文主要讲述Nginx结合GeoIP2实现对不同地区用户提供不同的服务。通过为在编译Nginx时加入ngx_http_geoip2模块，结合免费的geolite2数据库，实现用户来源的筛选。</p>\n<span id=\"more\"></span>\n<h2 id=\"系统环境\"><a href=\"#系统环境\" class=\"headerlink\" title=\"系统环境\"></a>系统环境</h2><p>OS:Ubuntu 18.04<br>Nginx: 1.8.0</p>\n<h2 id=\"Nginx的编译\"><a href=\"#Nginx的编译\" class=\"headerlink\" title=\"Nginx的编译\"></a>Nginx的编译</h2><h3 id=\"geoip2-nginx模块\"><a href=\"#geoip2-nginx模块\" class=\"headerlink\" title=\"geoip2-nginx模块\"></a>geoip2-nginx模块</h3><p>geoip2-nginx模块</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">git clone https:&#x2F;&#x2F;github.com&#x2F;TravelEngineers&#x2F;ngx_http_geoip2_modulenginx-1.8.0<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<h3 id=\"geoip2-依赖配置\"><a href=\"#geoip2-依赖配置\" class=\"headerlink\" title=\"geoip2  依赖配置\"></a>geoip2  依赖配置</h3><p>核心识别库 libmaxminddb，可在<a href=\"https://github.com/maxmind/libmaxminddb/releases\">https://github.com/maxmind/libmaxminddb/releases</a> 找到最新版本。</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">wget  https:&#x2F;&#x2F;github.com&#x2F;maxmind&#x2F;libmaxminddb&#x2F;releases&#x2F;download&#x2F;1.4.2&#x2F;libmaxminddb-1.4.2.tar.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>安装</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">cd libmaxminddb-1.3.2\n.&#x2F;configure\nmake\nmake check\nsudo make install\nsudo ldconfig<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"nginx配置及安装\"><a href=\"#nginx配置及安装\" class=\"headerlink\" title=\"nginx配置及安装\"></a>nginx配置及安装</h3><p>下载Nginx并解压<br>进入：cd nginx-1.8.0，配置：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">.&#x2F;configure --with-http_ssl_module --add-module&#x3D;..&#x2F;ngx_http_geoip2_module --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>可能会提示提示缺少部分包，安装即可</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">解决依赖包openssl安装，命令：\nsudo apt-get install openssl libssl-dev\n解决依赖包pcre安装，命令：\nsudo apt-get install libpcre3 libpcre3-dev\n解决依赖包zlib安装，命令：\nsudo apt-get install zlib1g-dev<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>重新配置并安装</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">配置：.&#x2F;configure --with-http_ssl_module --add-module&#x3D;..&#x2F;ngx_http_geoip2_module --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx\n编译：make\n安装：make install\n启动：&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -c &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf\n重启：&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s  reload<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>至此，nginx应该已经安装完成，并且启动</p>\n<h2 id=\"Nginx配置\"><a href=\"#Nginx配置\" class=\"headerlink\" title=\"Nginx配置\"></a>Nginx配置</h2><p>下载geoip数据库然后在访问nginx时，会发现在响应头中已经带了<br><a href=\"https://dev.maxmind.com/geoip/geoip2/geolite2/\">https://dev.maxmind.com/geoip/geoip2/geolite2/</a><br>需要下载国家和城市的数据<br>修改nginx.conf<br>http节点添加</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">geoip2 ..&#x2F;GeoLite2-Country.mmdb &#123;\n        $geoip2_data_country_code country iso_code;\n        $geoip2_country_code default&#x3D;US country iso_code;\n        $geoip2_country_name country names zh-CN;\n&#125;\n\ngeoip2 ..&#x2F;GeoLite2-City.mmdb &#123;\n         $geoip2_city_name default&#x3D;ShangHai city names en;\n# zh-CN;\n         $geoip2_continent_code continent code;\n    &#125;\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>如果需要在响应头中输出城市、国家的名字，可在server节点添加如下信息：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">add_header &quot;country&quot; $geoip2_data_country_code;\nadd_header &quot;city&quot; $geoip2_city_name;\nadd_header &quot;c_name&quot; $geoip2_country_name;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<p>在location节点中，根据国家所在地，判断是否向用户提供服务，可添加如下信息</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">if ($geoip2_data_country_code &#x3D; CN) &#123;\n\n&#125;\nif ($geoip2_data_country_code !&#x3D; CN) &#123;\n   return 403;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"Referenced\"><a href=\"#Referenced\" class=\"headerlink\" title=\"Referenced\"></a>Referenced</h2><p><a href=\"https://blog.csdn.net/z920954494/article/details/52132125\">1、ubuntu下安装nginx时依赖库zlib，pcre，openssl安装方法</a><br><a href=\"https://www.rootop.org/pages/4366.html\">2、nginx通过geoip2模块实现判断用户来源国家跳转中英站</a><br><a href=\"https://xiaobai697197.lofter.com/post/1dd20747_1c719d74e\">3、封面图</a></p>\n","more":"<h2 id=\"系统环境\"><a href=\"#系统环境\" class=\"headerlink\" title=\"系统环境\"></a>系统环境</h2><p>OS:Ubuntu 18.04<br>Nginx: 1.8.0</p>\n<h2 id=\"Nginx的编译\"><a href=\"#Nginx的编译\" class=\"headerlink\" title=\"Nginx的编译\"></a>Nginx的编译</h2><h3 id=\"geoip2-nginx模块\"><a href=\"#geoip2-nginx模块\" class=\"headerlink\" title=\"geoip2-nginx模块\"></a>geoip2-nginx模块</h3><p>geoip2-nginx模块</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">git clone https:&#x2F;&#x2F;github.com&#x2F;TravelEngineers&#x2F;ngx_http_geoip2_modulenginx-1.8.0<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<h3 id=\"geoip2-依赖配置\"><a href=\"#geoip2-依赖配置\" class=\"headerlink\" title=\"geoip2  依赖配置\"></a>geoip2  依赖配置</h3><p>核心识别库 libmaxminddb，可在<a href=\"https://github.com/maxmind/libmaxminddb/releases\">https://github.com/maxmind/libmaxminddb/releases</a> 找到最新版本。</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">wget  https:&#x2F;&#x2F;github.com&#x2F;maxmind&#x2F;libmaxminddb&#x2F;releases&#x2F;download&#x2F;1.4.2&#x2F;libmaxminddb-1.4.2.tar.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>安装</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">cd libmaxminddb-1.3.2\n.&#x2F;configure\nmake\nmake check\nsudo make install\nsudo ldconfig<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"nginx配置及安装\"><a href=\"#nginx配置及安装\" class=\"headerlink\" title=\"nginx配置及安装\"></a>nginx配置及安装</h3><p>下载Nginx并解压<br>进入：cd nginx-1.8.0，配置：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">.&#x2F;configure --with-http_ssl_module --add-module&#x3D;..&#x2F;ngx_http_geoip2_module --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n<p>可能会提示提示缺少部分包，安装即可</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">解决依赖包openssl安装，命令：\nsudo apt-get install openssl libssl-dev\n解决依赖包pcre安装，命令：\nsudo apt-get install libpcre3 libpcre3-dev\n解决依赖包zlib安装，命令：\nsudo apt-get install zlib1g-dev<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>重新配置并安装</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">配置：.&#x2F;configure --with-http_ssl_module --add-module&#x3D;..&#x2F;ngx_http_geoip2_module --prefix&#x3D;&#x2F;usr&#x2F;local&#x2F;nginx\n编译：make\n安装：make install\n启动：&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -c &#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf\n重启：&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx -s  reload<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>至此，nginx应该已经安装完成，并且启动</p>\n<h2 id=\"Nginx配置\"><a href=\"#Nginx配置\" class=\"headerlink\" title=\"Nginx配置\"></a>Nginx配置</h2><p>下载geoip数据库然后在访问nginx时，会发现在响应头中已经带了<br><a href=\"https://dev.maxmind.com/geoip/geoip2/geolite2/\">https://dev.maxmind.com/geoip/geoip2/geolite2/</a><br>需要下载国家和城市的数据<br>修改nginx.conf<br>http节点添加</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">geoip2 ..&#x2F;GeoLite2-Country.mmdb &#123;\n        $geoip2_data_country_code country iso_code;\n        $geoip2_country_code default&#x3D;US country iso_code;\n        $geoip2_country_name country names zh-CN;\n&#125;\n\ngeoip2 ..&#x2F;GeoLite2-City.mmdb &#123;\n         $geoip2_city_name default&#x3D;ShangHai city names en;\n# zh-CN;\n         $geoip2_continent_code continent code;\n    &#125;\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>如果需要在响应头中输出城市、国家的名字，可在server节点添加如下信息：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">add_header &quot;country&quot; $geoip2_data_country_code;\nadd_header &quot;city&quot; $geoip2_city_name;\nadd_header &quot;c_name&quot; $geoip2_country_name;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<p>在location节点中，根据国家所在地，判断是否向用户提供服务，可添加如下信息</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">if ($geoip2_data_country_code &#x3D; CN) &#123;\n\n&#125;\nif ($geoip2_data_country_code !&#x3D; CN) &#123;\n   return 403;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"Referenced\"><a href=\"#Referenced\" class=\"headerlink\" title=\"Referenced\"></a>Referenced</h2><p><a href=\"https://blog.csdn.net/z920954494/article/details/52132125\">1、ubuntu下安装nginx时依赖库zlib，pcre，openssl安装方法</a><br><a href=\"https://www.rootop.org/pages/4366.html\">2、nginx通过geoip2模块实现判断用户来源国家跳转中英站</a><br><a href=\"https://xiaobai697197.lofter.com/post/1dd20747_1c719d74e\">3、封面图</a></p>","categories":[],"tags":[{"name":"Nginx","path":"api/tags/Nginx.json"}]}